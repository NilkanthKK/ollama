
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>High Quality Invoice Extraction Tool</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            width: 100%;
            max-width: 800px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        header {
            background: #4a6fc0;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .description {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .upload-section {
            padding: 30px;
            text-align: center;
        }
        
        .upload-options {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .upload-option-btn {
            background: #f0f5ff;
            border: 2px solid #4a6fc0;
            border-radius: 8px;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #4a6fc0;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .upload-option-btn:hover {
            background: #4a6fc0;
            color: white;
        }
        
        .upload-area {
            border: 3px dashed #4a6fc0;
            border-radius: 12px;
            padding: 40px 20px;
            margin-bottom: 25px;
            background-color: #f8fafc;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            background-color: #e8f4ff;
            border-color: #3b5998;
        }
        
        .upload-icon {
            font-size: 60px;
            color: #4a6fc0;
            margin-bottom: 15px;
        }
        
        .file-input {
            display: none;
        }
        
        .camera-container {
            display: none;
            margin: 20px 0;
            text-align: center;
        }
        
        #cameraVideo {
            width: 100%;
            max-width: 500px;
            border-radius: 8px;
            background-color: #000;
            /* Removed the mirror effect (transform: scaleX(-1)) */
        }
        
        .camera-controls {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        .camera-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .capture-btn {
            background: #4a6fc0;
            color: white;
        }
        
        .cancel-camera-btn {
            background: #e74c3c;
            color: white;
        }
        
        .image-preview {
            margin: 20px auto;
            display: none;
            max-width: 100%;
            text-align: center;
        }
        
        .image-preview img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid #ddd;
        }
        
        .response-section {
            display: none;
            padding: 0 30px 30px;
        }
        
        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .response-title {
            font-size: 22px;
            color: #2c3e50;
        }
        
        .response-time {
            color: #7f8c8d;
            font-size: 14px;
            background: #f7f9fc;
            padding: 5px 10px;
            border-radius: 15px;
        }
        
        .response-data {
            background-color: #f8fafc;
            border-radius: 10px;
            padding: 20px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e1e8ed;
        }
        
        .json-key {
            color: #8e44ad;
            font-weight: 600;
        }
        
        .json-string {
            color: #27ae60;
        }
        
        .json-number {
            color: #e74c3c;
        }
        
        .json-boolean {
            color: #f39c12;
        }
        
        .loader {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .loader-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4a6fc0;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .message {
            display: none;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            font-weight: 500;
        }
        
        .error-message {
            color: #e74c3c;
            background-color: #fdeded;
            border: 1px solid #f5c6cb;
        }
        
        .success-message {
            color: #27ae60;
            background-color: #e6f7ee;
            border: 1px solid #c3e6cb;
        }
        
        .server-info {
            background: #2c3e50;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 14px;
            border-top: 1px solid #3a506b;
        }
        
        .quality-info {
            margin-top: 10px;
            font-size: 14px;
            color: #4a6fc0;
            background: #f0f5ff;
            padding: 8px;
            border-radius: 6px;
            display: inline-block;
        }
        
        @media (max-width: 600px) {
            .container {
                border-radius: 10px;
            }
            
            header {
                padding: 15px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .upload-section {
                padding: 20px;
            }
            
            .upload-area {
                padding: 25px 15px;
            }
            
            .response-section {
                padding: 0 20px 20px;
            }
            
            .upload-options {
                flex-direction: column;
            }
            
            #cameraVideo {
                max-width: 100%;
            }
        }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>High Quality Invoice Extraction Tool</h1>
      <p class="description">Upload an invoice image to extract details like party information, GST number, and items</p>
    </header>

    <div class="upload-section">
      <div class="upload-options">
        <button class="upload-option-btn" id="galleryBtn">
          <span>üìÅ</span> Choose from Gallery
        </button>
        <button class="upload-option-btn" id="cameraBtn">
          <span>üì∑</span> Capture with Camera
        </button>
      </div>

      <input type="file" id="imageInput" class="file-input" accept="image/*">

      <div class="camera-container" id="cameraContainer">
        <video id="cameraVideo" autoplay playsinline></video>
        <div class="camera-controls">
          <button class="camera-btn capture-btn" id="captureBtn">Capture High Quality Photo</button>
          <button class="camera-btn cancel-camera-btn" id="cancelCameraBtn">Cancel</button>
        </div>
        <p class="quality-info">Using high resolution settings for better text recognition</p>
      </div>

      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">üìÑ</div>
        <p>Drag & drop your invoice image here or select an option above</p>
      </div>

      <div class="image-preview" id="imagePreview">
        <img src="" alt="Invoice Preview">
      </div>

      <div class="loader" id="loader">
        <div class="loader-spinner"></div>
        <p>Processing your invoice... This may take a moment</p>
      </div>

      <div class="message error-message" id="errorMessage"></div>
      <div class="message success-message" id="successMessage"></div>
    </div>

    <div class="response-section" id="responseSection">
      <div class="response-header">
        <h2 class="response-title">Extracted Invoice Data</h2>
        <div class="response-time" id="responseTime"></div>
      </div>

      <div class="response-data">
        <pre id="responseData"></pre>
      </div>
    </div>

    <div class="server-info">
      <p>Server: <span id="serverAddress">Waiting for connection...</span></p>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const imageInput = document.getElementById('imageInput');
      const imagePreview = document.getElementById('imagePreview');
      const uploadArea = document.getElementById('uploadArea');
      const loader = document.getElementById('loader');
      const errorMessage = document.getElementById('errorMessage');
      const successMessage = document.getElementById('successMessage');
      const responseSection = document.getElementById('responseSection');
      const responseData = document.getElementById('responseData');
      const responseTime = document.getElementById('responseTime');
      const serverAddress = document.getElementById('serverAddress');
      const galleryBtn = document.getElementById('galleryBtn');
      const cameraBtn = document.getElementById('cameraBtn');
      const cameraContainer = document.getElementById('cameraContainer');
      const cameraVideo = document.getElementById('cameraVideo');
      const captureBtn = document.getElementById('captureBtn');
      const cancelCameraBtn = document.getElementById('cancelCameraBtn');

      // API URL configuration
      const apiUrl = "https://fc209ea9ee54.ngrok-free.app/extract-invoice";
      serverAddress.textContent = "fc209ea9ee54.ngrok-free.app";

      // Event listeners
      galleryBtn.addEventListener('click', () => imageInput.click());
      cameraBtn.addEventListener('click', startCamera);
      captureBtn.addEventListener('click', capturePhoto);
      cancelCameraBtn.addEventListener('click', stopCamera);

      // Drag & drop
      uploadArea.addEventListener('dragover', e => {
        e.preventDefault();
        uploadArea.style.backgroundColor = '#e8f4ff';
        uploadArea.style.borderColor = '#3b5998';
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.style.backgroundColor = '#f8fafc';
        uploadArea.style.borderColor = '#4a6fc0';
      });

      uploadArea.addEventListener('drop', e => {
        e.preventDefault();
        uploadArea.style.backgroundColor = '#f8fafc';
        uploadArea.style.borderColor = '#4a6fc0';
        if (e.dataTransfer.files.length) {
          handleImageUpload(e.dataTransfer.files[0]);
        }
      });

      // File selection
      imageInput.addEventListener('change', function() {
        if (imageInput.files.length) {
          handleImageUpload(imageInput.files[0]);
        }
      });

      // ---- Camera handling ----
      let stream = null;

      async function startCamera() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          showError("Camera not supported in this browser.");
          return;
        }

        try {
          // Request the highest possible resolution
          const constraints = {
            video: {
              facingMode: 'environment', // Use the back camera
              width: { ideal: 4096 },    // Request 4K if available
              height: { ideal: 2160 },   // Request 4K if available
              frameRate: { ideal: 30 }   // Higher frame rate for clarity
            },
            audio: false
          };

          stream = await navigator.mediaDevices.getUserMedia(constraints);
          
          // Get the actual settings being used
          const track = stream.getVideoTracks()[0];
          const settings = track.getSettings();
          
          console.log(`Camera resolution: ${settings.width}x${settings.height}`);
          console.log(`Frame rate: ${settings.frameRate}`);
          
          cameraVideo.srcObject = stream;
          cameraContainer.style.display = 'block';
          uploadArea.style.display = 'none';
        } catch (err) {
          console.error('Camera error:', err);
          showError('Unable to access camera: ' + err.message);
        }
      }

      function stopCamera() {
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
          stream = null;
        }
        cameraContainer.style.display = 'none';
        uploadArea.style.display = 'block';
      }

      function capturePhoto() {
        const canvas = document.createElement('canvas');
        // Use the full video resolution
        canvas.width = cameraVideo.videoWidth;
        canvas.height = cameraVideo.videoHeight;
        const ctx = canvas.getContext('2d');
        
        // Draw the current frame from the video
        ctx.drawImage(cameraVideo, 0, 0, canvas.width, canvas.height);
        
        // Apply slight sharpening for better text recognition
        ctx.filter = 'contrast(1.1) brightness(1.1)';
        ctx.drawImage(canvas, 0, 0);
        ctx.filter = 'none';
        
        // Create a very high-quality JPEG (quality: 0.98)
        canvas.toBlob(function(blob) {
          const file = new File([blob], 'high-quality-invoice.jpg', { 
            type: 'image/jpeg',
            lastModified: Date.now()
          });
          
          handleImageUpload(file);
          stopCamera();
        }, 'image/jpeg', 0.98); // Very high quality
      }

      // ---- Upload image ----
      function handleImageUpload(file) {
        if (!file.type.match('image.*')) {
          showError('Please select an image file (JPEG, PNG, etc.)');
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          imagePreview.style.display = 'block';
          imagePreview.querySelector('img').src = e.target.result;
        };
        reader.readAsDataURL(file);

        uploadImage(file);
      }

      function uploadImage(file) {
        console.log('Uploading high quality image...', file);
        hideMessages();
        loader.style.display = 'block';
        responseSection.style.display = 'none';

        const formData = new FormData();
        formData.append('image', file);

        fetch(apiUrl, {
          method: 'POST',
          body: formData
        })
        .then(response => {
          if (!response.ok) {
            return response.json().then(err => { throw new Error(err.message || 'Server error'); });
          }
          return response.json();
        })
        .then(data => {
          loader.style.display = 'none';
          if (data.status === 'success') {
            showSuccess('Invoice processed successfully!');
            displayResponse(data);
          } else {
            showError(data.message || 'Failed to process invoice');
          }
        })
        .catch(error => {
          loader.style.display = 'none';
          showError(error.message || 'Failed to connect to server.');
          console.error('Error:', error);
        });
      }

      function displayResponse(data) {
        responseTime.textContent = `Processed in ${data.elapsed_time}`;
        const formattedJson = JSON.stringify(data.response, null, 2);
        responseData.innerHTML = syntaxHighlight(formattedJson);
        responseSection.style.display = 'block';
      }

      function syntaxHighlight(json) {
        json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
          function (match) {
            let cls = 'json-number';
            if (/^"/.test(match)) {
              cls = /:$/.test(match) ? 'json-key' : 'json-string';
            } else if (/true|false/.test(match)) {
              cls = 'json-boolean';
            } else if (/null/.test(match)) {
              cls = 'json-null';
            }
            return '<span class="' + cls + '">' + match + '</span>';
        });
      }

      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        successMessage.style.display = 'none';
      }

      function showSuccess(message) {
        successMessage.textContent = message;
        successMessage.style.display = 'block';
        errorMessage.style.display = 'none';
      }

      function hideMessages() {
        errorMessage.style.display = 'none';
        successMessage.style.display = 'none';
      }
    });
  </script>
</body>
</html>